#!/bin/bash

readonly DEPLOY_LOCATION="$1"

if [ -z "$DEPLOY_LOCATION" ]; then
  echo "You must provide the path to the directory you deploy to"
  exit 1
fi

if ! git diff-index --quiet HEAD --; then
  echo "Whoa there! You can't deploy with uncommitted changes!"
  exit 1
fi

(cd "$DEPLOY_LOCATION" && git pull -r) &&
yarn run build &&
# Replace the index.html generated by create-react-app with
# our own template which has placeholders for inline scripts
# and css
cp public/index.html build/ &&
# fill in the placeholders
sed -i.bak "/<style id=\"main-css\"/r $(ls build/static/css/*.css)" build/index.html &&
sed -i.bak "/<script id=\"main-script\"/r $(ls build/static/js/*.js)" build/index.html &&
rm build/index.html.bak &&
# put everything in the deploy directory
cp -r build/ "$DEPLOY_LOCATION/" &&
echo deployed $(git rev-parse HEAD)
